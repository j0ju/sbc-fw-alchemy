#cloud-config
---
disable_root: true
fqdn: bpi2m0.local
hostname: bpi2m0
manage_etc_hosts: true
package_update: false
ssh_pwauth: true

users: []

# this is overridden bei runcmd section in user-data
runcmd:
  - |
    PS4="runcmd: "; set -e; trap `exit $?` EXIT
    set -x
    
    # this ensures that cloud init is only running once
    echo "disabled by /boot/cloud-init/vendor-data" > /etc/cloud/cloud-init.disabled

write_files:
  - path: /etc/network/interfaces
    permissions: '0644'
    owner: root:root
    content: |
      # /etc/network/interfaces
      # generated by cloud-init
      # The config is split into serveral snippets below

      # loopback interface do not change
      auto lo
      iface lo inet loopback

      # include dynamic config
      source-directory /etc/network/interfaces.d

  - path: /etc/network/interfaces.d/wlan0
    permissions: '0644'
    owner: root:root
    content: |
      # /etc/network/interfaces.d/wlan0
      # example config generated by cloud-init
      # remove # before auto, for automatic connection on bootup
      #auto wlan0
      iface wlan0
        use dhcp
        wifi-config-path /etc/wpa_supplicant/wlan0.conf

  - path: /etc/network/interfaces.d/ap0
    permissions: '0644'
    owner: root:root
    content: |
      # /etc/network/interfaces.d/ap0
      # example config generated by cloud-init
      # remove # before auto, for automatic connection on bootup
      #auto ap0
      iface ap0
        address 201.0.113.42/24
        pre-up iw phy phy0 interface add $IFACE type __ap
        # hostapd and dnsmasq call are TODO
        post-down iw dev $IFACE del

  - path: /etc/wpa_supplicant/wlan0.conf
    permissions: '0644'
    owner: root:root
    content: |
      # /etc/network/interfaces.d/wlan0
      # example config generated by cloud-init
      update_config=1

      country=DE

      # WPA3
      network={
        ssid="wpa3"
        key_mgmt=SAE
        sae_password="secret"
        ieee80211w=2
      }
      # WPA2/3
      network={
        ssid="wpa2/3"
        psk="secret"
        key_mgmt=WPA-PSK-SHA256
        ieee80211w=2
      }
      # WPA2
      network={
        ssid="wpa2"
        psk="secret"
        key_mgmt=WPA-PSK
      }

# vim: ts=2 sw=2 et ft=yaml
