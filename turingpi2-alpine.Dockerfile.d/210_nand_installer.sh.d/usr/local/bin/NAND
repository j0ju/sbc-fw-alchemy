#!/bin/sh
set -eu

unlock() {
  BOOTDEV="$(busybox mountpoint -n /boot/. | cut -f1 -d" ")"
  mount -o remount -w "$BOOTDEV"
  sed -i -e '/if env exists boot_unlocked/ i setenv boot_unlocked yes' /boot/boot.scr
  mkimage -T script -d /boot/boot.scr /boot/boot.scr.uimg > /dev/null
  mount -o remount -r "$BOOTDEV"
  status
}

lock() {
  BOOTDEV="$(busybox mountpoint -n /boot/. | cut -f1 -d" ")"
  mount -o remount -w "$BOOTDEV"
  sed -i -e '/setenv boot_unlocked yes/ d' /boot/boot.scr
  mkimage -T script -d /boot/boot.scr /boot/boot.scr.uimg > /dev/null
  mount -o remount -r "$BOOTDEV"
  status
}

status() {
  # do a null write
  # according to some meaningful content this did not erase that flash page
  #   root @ tpi2bmc > ~ > head -c 64 /dev/mtd0 | hexdump -C
  #   00000000  16 00 00 ea 65 47 4f 4e  2e 42 54 30 70 7c 4e eb  |....eGON.BT0p|N.|
  #   00000010  00 60 00 00 53 50 4c 02  00 00 00 00 00 00 00 00  |.`..SPL.........|
  #   00000020  2c 00 00 00 00 00 00 00  00 00 00 00 73 75 6e 38  |,...........sun8|
  #   00000030  69 2d 74 31 31 33 73 2d  74 75 72 69 6e 67 2d 70  |i-t113s-turing-p|
  #   00000040
  #   root @ tpi2bmc > ~ > : > /dev/mtd0
  #   root @ tpi2bmc > ~ > head -c 64 /dev/mtd0 | hexdump -C
  #   00000000  16 00 00 ea 65 47 4f 4e  2e 42 54 30 70 7c 4e eb  |....eGON.BT0p|N.|
  #   00000010  00 60 00 00 53 50 4c 02  00 00 00 00 00 00 00 00  |.`..SPL.........|
  #   00000020  2c 00 00 00 00 00 00 00  00 00 00 00 73 75 6e 38  |,...........sun8|
  #   00000030  69 2d 74 31 31 33 73 2d  74 75 72 69 6e 67 2d 70  |i-t113s-turing-p|
  #
  nstate=UNKNOWN
  if grep ^"setenv boot_unlocked" /boot/boot.scr.uimg; then
    nstate="UNLOCKED /dev/mtd0 (boot)"
  else
    nstate="LOCKED /dev/mtd0 (boot)"
  fi
  echo "NEXT BOOT: $nstate"

  cstate=UNKNOWN
  rs=69
  if ( exec 2> /dev/null; : > /dev/mtd0 ); then
    cstate="UNLOCKED /dev/mtd0 (boot)"
    rs=0
  else
    cstate="LOCKED /dev/mtd0 (boot)"
  fi
  echo "CURRENT  : $cstate"

  if [ "$cstate" != "$nstate" ]; then
    echo "I: Reboot needed."
  fi
  return $rs
}


CMD="${1:-}"
shift 2> /dev/null || :
case "$CMD" in
  unlock | u )       unlock "$@" ;;
  lock   | l )       lock "$@" ;;
  status | st | "" ) status "$@" ;;
esac
