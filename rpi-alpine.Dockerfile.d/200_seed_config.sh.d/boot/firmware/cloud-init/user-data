#cloud-config
---
disable_root: true
fqdn: rpi.local
hostname: rpi
manage_etc_hosts: true
package_update: false
ssh_pwauth: true

users: []

# this is overridden bei runcmd section in user-data
runcmd:
  - |
    PS4="runcmd: "; set -e; trap `exit $?` EXIT
    set -ex

    # this ensures that cloud init is only running once
    echo "disabled by /boot/cloud-init/user-data" > /etc/cloud/cloud-init.disabled

    [ -d /sys/class/net/eth0 ] || rm -f /etc/network/interfaces.d/eth0
    ifup -a

write_files:
  - path: /etc/network/interfaces
    permissions: '0644'
    owner: root:root
    content: |
      # /etc/network/interfaces
      # generated by cloud-init
      # The config is split into serveral snippets below

      # loopback interface do not change
      auto lo
      iface lo inet loopback

      # include dynamic config
      source-directory /etc/network/interfaces.d

  - path: /etc/network/interfaces.d/wlan0
    permissions: '0644'
    owner: root:root
    content: |
      # /etc/network/interfaces.d/wlan0
      # example config generated by cloud-init
      # remove # before auto, for automatic connection on bootup
      #auto wlan0
      iface wlan0
        use dhcp
        wifi-config-path /etc/wpa_supplicant/wlan0.conf

  - path: /etc/network/interfaces.d/eth0
    permissions: '0644'
    owner: root:root
    content: |
      # /etc/network/interfaces.d/wlan0
      # example config generated by cloud-init
      # remove # before auto, for automatic connection on bootup
      auto eth0
      iface eth0
        use dhcp
        # sync MAC addresses of eth0 and wlan0
        pre-up exec 2> /dev/null; read hwaddr < /sys/class/net/wlan0/address && ip link set addr $hwaddr dev eth0

  - path: /etc/network/interfaces.d/ap0
    permissions: '0644'
    owner: root:root
    content: |
      # /etc/network/interfaces.d/ap0
      # example config generated by cloud-init
      # remove # before auto, for automatic connection on bootup
      #auto ap0
      iface ap0
        address 201.0.113.42/24
        pre-up iw phy phy0 interface add $IFACE type __ap
        ##TODO: call to hostapd
        #up /usr/sbin/hostapd -i $IFACE -P /run/hostapd.$IFACE.pid /etc/hostapd/$IFACE.conf
        #pre-down kill $(cat /run/hostapd.$IFACE.pid 2> /dev/null) 2> /dev/null || :
        ##TODO: dnsmasq call
        post-down iw dev $IFACE del

  - path: /etc/hostapd/ap0.conf
    permissions: '0644'
    owner: root:root
    content: |
      # hostapd config for accesspoint on ap0 interface
      #interface=ap0
      driver=nl80211
      ssid=rpi-alpine
      
      hw_mode=g
      channel=6
      
      wpa=2
      wpa_passphrase=rpi-alpine!
      wpa_key_mgmt=SAE
      rsn_pairwise=CCMP
      
      ieee80211w=2
      ieee80211n=1
      ieee80211d=1
      country_code=DE
      wmm_enabled=1

  - path: /etc/wpa_supplicant/wlan0.conf
    permissions: '0644'
    owner: root:root
    content: |
      # /etc/network/interfaces.d/wlan0
      # example config generated by cloud-init
      update_config=1

      country=DE

      #network={
      #  ssid="wpa2"
      #  psk="foobar"
      #  key_mgmt=WPA-PSK
      #}

  - path: /etc/chrony/chrony.conf
    permissions: '0644'
    owner: root:root
    content: |
      server ptbtime1.ptb.de
      server ptbtime2.ptb.de
      server ptbtime3.ptb.de
      server ptbtime4.ptb.de

      initstepslew 30 ptbtime1.ptb.de ptbtime2.ptb.de ptbtime3.ptb.de ptbtime4.ptb.de
      # Allow the system clock to be stepped in the first three updates
      # if its offset is larger than 1 second.
      makestep 1.0 3

      driftfile /var/lib/chrony/chrony.drift
      rtcsync
      cmdport 0

  #- path: /home/pi/.ssh/authorized_keys
  #  permissions: '0644'
  #  owner: pi:pi
  #  content: |
  #    ssh-rsa something==

# vim: ts=2 sw=2 et ft=yaml
