#cloud-config
---
disable_root: true
fqdn: rk1.local
hostname: rk1
manage_etc_hosts: true
package_update: false
ssh_pwauth: true

users: []

# this is overridden bei runcmd section in user-data
runcmd:
  - |
    PS4="runcmd: "; set -e; trap `exit $?` EXIT
    set -ex

    # this ensures that cloud init is only running once
    ( set +x
      rc-update | while read svc _ runlevels; do
        case "$svc" in
          cloud-* )
            for lvl in $runlevels; do
            ( set -x
              rc-update del $svc $lvl
            )
            done
            ;;
        esac
      done
    )
    detached_cleanup() {
      set -x
      # detach from service cgroup (openrc / systemd) to prevent killing lingering procs
      if read pid _ < /proc/self/stat && [ -f /sys/fs/cgroup/cgroup.procs ]; then
        echo $pid > /sys/fs/cgroup/cgroup.procs
      fi

      # wait until parent finished
      while [ -d "/proc/$$" ]; do
        sleep 7
      done

      cloud-init clean
      echo "disabled by /boot/cloud-init/user-data" > /etc/cloud/cloud-init.disabled
      rm -rf /var/lib/cloud

      [ -x /boot/runcmd.ci ] && \
        exec /boot/runcmd.ci
    }
    trap 'rs=$?; detached_cleanup & exit $rs' EXIT

    #- fix permission of  ~pi
    echo turing:rk1 | chpasswd
    chown -R turing: ~turing

    #- podman - move storage dir away from overlay and enable cgroups
    rc-update add cgroups sysinit
    /etc/init.d/cgroups start
    rm -rf /var/lib/containers
    mkdir -p /overlay/containers
    ln -sf /overlay/containers /var/lib/containers

    #- do fstrim on /rom/mnt if avail to release a bit pressure from the FTL
    if mount -o remount -w /rom/mnt; then
      fstrim /rom/mnt || :
      mount -o remount -r /rom/mnt || :
    fi

    #- ensure network config
    ifup -a || reboot

    #- start rc.local
    /etc/init.d/rc.local start

write_files:
  - path: /etc/network/interfaces.d/eth0
    permissions: '0644'
    owner: root:root
    content: |
      # /etc/network/interfaces.d/wlan0
      # example config generated by cloud-init
      auto eth0
      iface eth0
        use dhcp
        use ipv6-ra
        ipv6-ll yes

        # sync MAC addresses of eth0 and wlan0
        pre-up exec 2> /dev/null; ip link set name eth0 dev end0 || ip link set name eth0 dev end1 || :

  #- path: /home/pi/.ssh/authorized_keys
  #  permissions: '0644'
  #  owner: pi:pi
  #  content: |
  #    ssh-rsa something==

# vim: ts=2 sw=2 et ft=yaml
